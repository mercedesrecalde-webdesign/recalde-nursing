<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Portal de Enfermer√≠a Domiciliaria">
    <title>Recalde Nursing</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
        }
        .overflow-y-auto::-webkit-scrollbar { width: 6px; }
        .overflow-y-auto::-webkit-scrollbar-track { background: #f1f5f9; }
        .overflow-y-auto::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .modal-blur { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        button { -webkit-tap-highlight-color: transparent; }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        .logo-float { animation: float 3s ease-in-out infinite; }
        
        .notification-toast {
            position: fixed !important;
            top: 80px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            z-index: 99999 !important;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
          getFirestore, collection, doc, onSnapshot, updateDoc, setDoc, addDoc, deleteDoc, writeBatch, getDocs, query, where, getDocsFromServer 
        } from 'firebase/firestore';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { 
          X, Search, Plus, Trash2, WifiOff, Mail, MailOpen, AlertTriangle, LogOut, Send, CheckCircle, Edit3, RefreshCw
        } from 'lucide-react';

        const firebaseConfig = {
            apiKey: "AIzaSyD_S99nIcE08-yPbdbEYr_okxptZ7m9csI",
            authDomain: "recalde-nursing.firebaseapp.com",
            projectId: "recalde-nursing",
            storageBucket: "recalde-nursing.firebasestorage.app",
            messagingSenderId: "761960971726",
            appId: "1:761960971726:web:6e45cc9f47f4c7c0a3bf9f",
            measurementId: "G-JDPS91FFJY"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const APP_ID_DB = 'recalde-care-final-v1';
        const ADMIN_ID = "admin_test";
        const ADMIN_PIN = "1234";
        const MASTER_KEY = "PMR_91";

        const UNIDADES_INCONTABLES = ['TUBO', 'FRASCO', 'BOTELLA', 'POTE', 'PACK', 'ROLLO', 'AERO'];

        const UNIT_OPTIONS = [
            { value: 'UNID', label: 'Unidad' },
            { value: 'COMP', label: 'Comprimido' },
            { value: 'SOBRE', label: 'Sobre' },
            { value: 'AMP', label: 'Ampolla' },
            { value: 'PAR', label: 'Par' },
            { value: 'CAJA', label: 'Caja' },
            { value: 'FRASCO', label: 'Frasco' },
            { value: 'BOTELLA', label: 'Botella' },
            { value: 'TUBO', label: 'Tubo' },
            { value: 'POTE', label: 'Pote' },
            { value: 'PACK', label: 'Pack' },
            { value: 'ROLLO', label: 'Rollo' },
            { value: 'AERO', label: 'Aerosol' }
        ];

        const INITIAL_INVENTORY = [
            { id: "1", cat: 'Farmacia', name: "ALCON LAGRIMAS II", unit: "FRASCO", min: 1 },
            { id: "2", cat: 'Farmacia', name: "ALCOHOL X 500 ML", unit: "FRASCO", min: 1 },
            { id: "3", cat: 'Farmacia', name: "ALGOD√ìN HIDR√ìFILO X500G", unit: "PACK", min: 1 },
            { id: "4", cat: 'Farmacia', name: "BAREX UNIPEG (PEG 3350)", unit: "SOBRE", min: 15 },
            { id: "5", cat: 'Insumos', name: "BOT√ìN GTT MIC-KEY 18FR", unit: "UNID", min: 1 },
            { id: "6", cat: 'Insumos', name: "C√ÅNULA TQT PORTEX N¬∞8", unit: "UNID", min: 1 },
            { id: "7", cat: 'Farmacia', name: "CLONAGIN SL (0.25MG SUBL)", unit: "COMP", min: 30 },
            { id: "8", cat: 'Farmacia', name: "CLONAZEPAM 2MG COMP", unit: "COMP", min: 30 },
            { id: "9", cat: 'Farmacia', name: "CLORHEXIDINA COLUT X500ML", unit: "FRASCO", min: 1 },
            { id: "10", cat: 'Insumos', name: "COLLARINES TRAQUEOSTOM√çA", unit: "UNID", min: 10 },
            { id: "11", cat: 'Insumos', name: "FILTRO HUMIDIFICADOR HME", unit: "UNID", min: 5 },
            { id: "12", cat: 'Insumos', name: "FILTROS HIDROF√ìBICOS", unit: "UNID", min: 5 },
            { id: "13", cat: 'Farmacia', name: "GASAS EST√âRILES 10X10", unit: "SOBRE", min: 100 },
            { id: "14", cat: 'Farmacia', name: "GASAS NO TEJIDAS 10X10", unit: "SOBRE", min: 100 },
            { id: "15", cat: 'Farmacia', name: "GOTABIOTIC D (OFTALMICO)", unit: "FRASCO", min: 1 },
            { id: "16", cat: 'Farmacia', name: "GUANTES EST√âRILES", unit: "PAR", min: 2 },
            { id: "17", cat: 'Farmacia', name: "GUANTES DESCARTABLES", unit: "CAJA", min: 5 },
            { id: "18", cat: 'Insumos', name: "GU√çAS MACROGOTERO", unit: "UNID", min: 10 },
            { id: "19", cat: 'Farmacia', name: "JERINGAS 20ML S/AGUJA", unit: "UNID", min: 10 },
            { id: "20", cat: 'Farmacia', name: "JERINGAS 60ML TOMEY", unit: "UNID", min: 10 },
            { id: "21", cat: 'Farmacia', name: "KEPPRA 500MG X60", unit: "COMP", min: 30 },
            { id: "22", cat: 'Farmacia', name: "LORAZEPAN CHOBET 2.5MG", unit: "COMP", min: 30 },
            { id: "23", cat: 'Farmacia', name: "LOSEC 20MG X28", unit: "COMP", min: 14 },
            { id: "24", cat: 'Farmacia', name: "MICOLIS CREMA X 30G", unit: "TUBO", min: 1 },
            { id: "25", cat: 'Insumos', name: "NUTRISON 1.0 KCAL (PACK)", unit: "PACK", min: 7 },
            { id: "26", cat: 'Farmacia', name: "PA√ëALES COMOD√çN ULTRA", unit: "UNID", min: 100 },
            { id: "27", cat: 'Farmacia', name: "PLATSUL CREMA X 100G", unit: "POTE", min: 1 },
            { id: "28", cat: 'Farmacia', name: "ROGASTRIL 1MG X30", unit: "COMP", min: 30 },
            { id: "29", cat: 'Farmacia', name: "SABRIL 500MG X60", unit: "COMP", min: 20 },
            { id: "30", cat: 'Insumos', name: "ASPIRACI√ìN CIRCUITO CERRADO", unit: "UNID", min: 5 },
            { id: "31", cat: 'Insumos', name: "SONDAS ASPIRACI√ìN K32", unit: "UNID", min: 50 },
            { id: "32", cat: 'Farmacia', name: "TRILEPTAL 300MG X30", unit: "COMP", min: 15 },
            { id: "33", cat: 'Farmacia', name: "UROKIT 30 COMP", unit: "COMP", min: 10 },
            { id: "34", cat: 'Farmacia', name: "VALCOTE 500MG", unit: "COMP", min: 25 },
            { id: "35", cat: 'Farmacia', name: "VENTOLIN HFA (SALBUTAMOL)", unit: "AERO", min: 2 },
            { id: "36", cat: 'Insumos', name: "TELA ADHESIVA", unit: "ROLLO", min: 2 }
        ];

        const INITIAL_NURSES = [
            { id: ADMIN_ID, name: 'Administrador', pin: ADMIN_PIN, email: 'pmrecalde91@gmail.com', profileComplete: true, needsReset: false },
            { id: 'fed', name: 'Federico', pin: '1111', email: '', profileComplete: false, needsReset: false },
            { id: 'mic', name: 'Micaela', pin: '2222', email: '', profileComplete: false, needsReset: false },
            { id: 'gis', name: 'Gisela', pin: '3333', email: '', profileComplete: false, needsReset: false },
            { id: 'alm', name: 'Alma', pin: '4444', email: '', profileComplete: false, needsReset: false }
        ];

        function GlobalNotification({ message, type = 'success' }) {
            if (!message) return null;
            
            const bgColor = type === 'success' ? 'bg-emerald-500' : 
                           type === 'warning' ? 'bg-amber-500' : 
                           type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            return (
                <div className="notification-toast">
                    <div className={`px-8 py-6 ${bgColor} text-white rounded-3xl shadow-2xl font-black text-sm uppercase text-center max-w-md animate-pulse flex items-center gap-3`}>
                        <CheckCircle className="w-5 h-5 shrink-0" />
                        <span>{message}</span>
                    </div>
                </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [inventory, setInventory] = useState(INITIAL_INVENTORY.map(i => ({...i, firebaseId: i.id, stockDomicilio: 50})));
            const [nurses, setNurses] = useState(INITIAL_NURSES);
            
            const [authLoading, setAuthLoading] = useState(true);
            const [notification, setNotification] = useState(null);
            const [notificationType, setNotificationType] = useState('success');
            const [search, setSearch] = useState('');
            const [activeNurse, setActiveNurse] = useState(null);
            
            const [sessionUsage, setSessionUsage] = useState({});
            const [sessionRestocks, setSessionRestocks] = useState({});
            
            const [loginForm, setLoginForm] = useState({ id: '', pin: '' });
            const [loginError, setLoginError] = useState('');
            const [showShiftEnd, setShowShiftEnd] = useState(false);
            const [showAddSupply, setShowAddSupply] = useState(false);
            const [showNurseModal, setShowNurseModal] = useState(false);
            const [showForgotPin, setShowForgotPin] = useState(false);
            const [view, setView] = useState('login'); 
            const [setupData, setSetupData] = useState({ fullName: '', newPin: '', confirmPin: '' });
            const [newSupply, setNewSupply] = useState({ name: '', unit: 'UNID', cat: 'Farmacia', min: 1 });
            const [nurseEditor, setNurseEditor] = useState({ id: '', name: '', email: '', pin: '', mode: 'add' });
            const [offlineMode, setOfflineMode] = useState(false);
            const [messages, setMessages] = useState([]);
            const [showMessages, setShowMessages] = useState(false);
            const [selectedMessage, setSelectedMessage] = useState(null);
            const [debugLog, setDebugLog] = useState([]);
            const [showDebug, setShowDebug] = useState(false);
            
            // FIX #1: Estado para editar insumo
            const [showEditSupply, setShowEditSupply] = useState(false);
            const [editSupplyData, setEditSupplyData] = useState({ firebaseId: '', name: '', unit: 'UNID', cat: 'Farmacia', min: 1, stockDomicilio: 0 });

            const showNotification = useCallback((message, type = 'success', duration = 3500) => {
                console.log('üì¢ NOTIFICACI√ìN:', message);
                setNotification(message);
                setNotificationType(type);
                setTimeout(() => setNotification(null), duration);
            }, []);

            const addDebugLog = (msg) => {
                const timestamp = new Date().toLocaleTimeString();
                setDebugLog(prev => [...prev.slice(-20), `[${timestamp}] ${msg}`]);
                console.log(msg);
            };

            useEffect(() => {
                const initialize = async () => {
                    try {
                        console.log('üîê Iniciando autenticaci√≥n an√≥nima...');
                        const userCredential = await signInAnonymously(auth);
                        console.log('‚úÖ Autenticaci√≥n exitosa. UID:', userCredential.user.uid);
                    } catch (e) { 
                        console.error("‚ùå Auth error:", e.code, e.message); 
                        setOfflineMode(true);
                    }
                };
                initialize();
                return onAuthStateChanged(auth, u => {
                    if (u) {
                        console.log('üë§ Usuario autenticado:', u.uid);
                    } else {
                        console.log('üë§ Sin usuario');
                    }
                    setUser(u);
                    setAuthLoading(false);
                });
            }, []);

            useEffect(() => {
                if (!user) {
                    console.log('‚è≥ Esperando autenticaci√≥n...');
                    return;
                }
                console.log('üì° Conectando a Firebase Firestore...');
                const rootRef = doc(db, 'artifacts', APP_ID_DB, 'public', 'data'); 
                
                const unsubInv = onSnapshot(collection(rootRef, 'inventory_stable'), (snap) => {
                    console.log('üì¶ Inventario recibido:', snap.docs.length, 'items');
                    if (!snap.empty) {
                        setInventory(snap.docs.map(d => ({ ...d.data(), firebaseId: d.id })).sort((a, b) => a.name.localeCompare(b.name)));
                        setOfflineMode(false);
                    } else if (snap.empty && !offlineMode) {
                        console.log('üì¶ Inventario vac√≠o, inicializando...');
                        const batch = writeBatch(db);
                        INITIAL_INVENTORY.forEach(item => batch.set(doc(collection(rootRef, 'inventory_stable'), item.id), { ...item, stockDomicilio: 50 }));
                        batch.commit()
                            .then(() => console.log('‚úÖ Inventario inicializado'))
                            .catch((e) => {
                                console.error('‚ùå Error inicializando inventario:', e.code, e.message);
                                setOfflineMode(true);
                            }); 
                    }
                }, (err) => { 
                    console.error('‚ùå Error escuchando inventario:', err.code, err.message);
                    setOfflineMode(true); 
                });

                const unsubNurse = onSnapshot(collection(rootRef, 'nurses'), (snap) => {
                    console.log('üë• Enfermeros recibidos:', snap.docs.length);
                    if (!snap.empty) {
                        setNurses(snap.docs.map(d => ({ ...d.data(), firebaseId: d.id })));
                    } else if (snap.empty && !offlineMode) {
                        console.log('üë• Lista vac√≠a, inicializando enfermeros...');
                        const batch = writeBatch(db);
                        INITIAL_NURSES.forEach(n => batch.set(doc(collection(rootRef, 'nurses'), n.id), n));
                        batch.commit()
                            .then(() => console.log('‚úÖ Enfermeros inicializados'))
                            .catch((e) => console.error('‚ùå Error inicializando enfermeros:', e.code, e.message));
                    }
                }, (err) => {
                    console.error('‚ùå Error escuchando enfermeros:', err.code, err.message);
                });

                const unsubMessages = onSnapshot(collection(rootRef, 'messages'), (snap) => {
                    console.log('‚úâÔ∏è Mensajes recibidos:', snap.docs.length);
                    if (!snap.empty) {
                        const loadedMessages = snap.docs.map(d => ({ ...d.data(), id: d.id })).sort((a, b) => 
                            new Date(b.timestamp) - new Date(a.timestamp)
                        );
                        setMessages(loadedMessages);
                        
                        // FIX #5: Auto-borrar mensajes de enfermeros mayores a 7 d√≠as
                        const oneWeekAgo = new Date();
                        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                        
                        loadedMessages.forEach(msg => {
                            if (msg.to === 'Enfermeros' && new Date(msg.timestamp) < oneWeekAgo) {
                                deleteDoc(doc(db, 'artifacts', APP_ID_DB, 'public', 'data', 'messages', msg.id))
                                    .catch(e => console.log('Error auto-borrando mensaje:', e));
                            }
                        });
                    }
                }, (err) => {
                    console.error("‚ùå Error cargando mensajes:", err.code, err.message);
                });

                return () => { unsubInv(); unsubNurse(); unsubMessages(); };
            }, [user, offlineMode]);

            const updateLocalAndRemote = async (collectionName, docId, data) => {
                console.log(`üì§ Guardando en ${collectionName}/${docId}:`, data);
                try {
                    const docRef = doc(db, 'artifacts', APP_ID_DB, 'public', 'data', collectionName, docId);
                    await setDoc(docRef, data, { merge: true });
                    console.log(`‚úÖ Guardado exitoso en ${collectionName}/${docId}`);
                    setOfflineMode(false);
                    return true;
                } catch (e) {
                    console.error(`‚ùå Error guardando en ${collectionName}/${docId}:`, e);
                    console.error("C√≥digo:", e.code, "Mensaje:", e.message);
                    setOfflineMode(true);
                    return false;
                }
            };

            const handleLogin = (e) => {
                if (e) e.preventDefault();
                setLoginError('');
                if (loginForm.pin.toUpperCase() === MASTER_KEY.toUpperCase()) {
                    setView('manage_nurses');
                    setLoginForm({ id: '', pin: '' });
                    return;
                }
                const nurse = nurses.find(n => n.id === loginForm.id && n.pin === loginForm.pin);
                if (nurse) {
                    setActiveNurse(nurse);
                    if (nurse.needsReset) {
                        setView('reset_pin');
                        setSetupData({ fullName: nurse.name, newPin: '', confirmPin: '' });
                    } else if (!nurse.profileComplete) {
                        setView('setup_profile');
                    } else { 
                        setSessionUsage({}); 
                        setSessionRestocks({});
                        setView('portal'); 
                    }
                } else { 
                    setLoginError('PIN Incorrecto.'); 
                }
            };

            const handleForgotPin = async () => {
                addDebugLog("=== SOLICITUD DE AYUDA ===");
                
                if (!loginForm.id) {
                    setShowForgotPin(false);
                    showNotification('‚ö†Ô∏è Primero seleccione su nombre', 'warning');
                    return;
                }
                
                const nurse = nurses.find(n => n.id === loginForm.id);
                
                if (nurse && nurse.id !== ADMIN_ID) {
                    const updated = { ...nurse, needsReset: true };
                    setNurses(prev => prev.map(n => n.id === nurse.id ? updated : n));
                    setShowForgotPin(false);
                    showNotification('‚úì AYUDA SOLICITADA - El administrador resetear√° tu PIN', 'success', 4000);
                    
                    updateLocalAndRemote('nurses', nurse.id, { needsReset: true });
                    
                    setTimeout(() => setLoginForm({ id: '', pin: '' }), 4000);
                } else {
                    setShowForgotPin(false);
                }
            };

            // FIX #3: Notificaci√≥n clara de reseteo exitoso
            const handleResetNurseToDefault = async (nurse) => {
                addDebugLog("=== RESETEO DE PIN ===");
                
                const updated = { ...nurse, pin: '0000', needsReset: true };
                setNurses(prev => prev.map(n => n.id === nurse.id ? updated : n));
                
                // Mostrar notificaci√≥n MUY CLARA
                showNotification(`‚úì RESETEO EXITOSO - PIN de ${nurse.name} ahora es 0000`, 'success', 5000);
                
                await updateLocalAndRemote('nurses', nurse.id, { pin: '0000', needsReset: true });
            };

            // FIX #4: Asegurar que el PIN se guarde correctamente
            const handleDefineNewPin = async (e) => {
                e.preventDefault();
                addDebugLog("=== DEFINIR NUEVO PIN ===");
                
                if (setupData.newPin !== setupData.confirmPin) {
                    showNotification('‚ö†Ô∏è Los PINs no coinciden', 'warning');
                    return;
                }
                
                if (setupData.newPin.length < 4) {
                    showNotification('‚ö†Ô∏è El PIN debe tener al menos 4 d√≠gitos', 'warning');
                    return;
                }
                
                const newPinData = { 
                    pin: setupData.newPin, 
                    needsReset: false,
                    profileComplete: true
                };
                
                // Guardar en Firebase PRIMERO y esperar
                const success = await updateLocalAndRemote('nurses', activeNurse.id, newPinData);
                
                if (success) {
                    addDebugLog("‚úì PIN guardado en Firebase correctamente");
                    
                    const updatedNurse = { ...activeNurse, ...newPinData };
                    setNurses(prev => prev.map(n => n.id === activeNurse.id ? updatedNurse : n));
                    setActiveNurse(updatedNurse);
                    
                    showNotification('‚úÖ NUEVO PIN HABILITADO - Ingresando al portal...', 'success', 3000);
                    
                    setTimeout(() => {
                        setSessionUsage({});
                        setSessionRestocks({});
                        setView('portal');
                        setSetupData({ fullName: '', newPin: '', confirmPin: '' });
                    }, 2000);
                } else {
                    showNotification('‚ùå Error guardando PIN - Intente de nuevo', 'error');
                }
            };

            const handleCompleteProfile = async (e) => {
                e.preventDefault();
                
                if (!setupData.fullName.trim()) {
                    showNotification('‚ö†Ô∏è El nombre es obligatorio', 'warning');
                    return;
                }
                
                if (!setupData.newPin || setupData.newPin.length < 4) {
                    showNotification('‚ö†Ô∏è El PIN debe tener al menos 4 d√≠gitos', 'warning');
                    return;
                }
                
                if (setupData.newPin !== setupData.confirmPin) {
                    showNotification('‚ö†Ô∏è Los PINs no coinciden', 'warning');
                    return;
                }
                
                const updated = { 
                    name: setupData.fullName.toUpperCase(),
                    pin: setupData.newPin,
                    profileComplete: true,
                    needsReset: false
                };
                
                // Guardar en Firebase PRIMERO y esperar confirmaci√≥n
                showNotification('‚è≥ Guardando perfil...', 'info', 2000);
                const success = await updateLocalAndRemote('nurses', activeNurse.id, updated);
                
                if (success) {
                    // Solo actualizar UI si Firebase confirm√≥
                    setActiveNurse({ ...activeNurse, ...updated });
                    setNurses(prev => prev.map(n => n.id === activeNurse.id ? { ...n, ...updated } : n));
                    showNotification('‚úÖ PERFIL Y PIN GUARDADOS', 'success');
                    
                    setTimeout(() => {
                        setSessionUsage({});
                        setSessionRestocks({});
                        setView('portal');
                        setSetupData({ fullName: '', newPin: '', confirmPin: '' });
                    }, 1500);
                } else {
                    showNotification('‚ùå Error guardando perfil - Intente de nuevo', 'error');
                }
            };

            const handleRegisterUsage = async (item) => {
                const isIncontable = UNIDADES_INCONTABLES.includes(item.unit);
                
                setSessionUsage(prev => ({ 
                    ...prev, 
                    [item.name]: { 
                        uses: (prev[item.name]?.uses || 0) + 1, 
                        unit: item.unit 
                    } 
                }));
                
                if (!isIncontable) {
                    if (item.stockDomicilio > 0) {
                        const newStock = item.stockDomicilio - 1;
                        setInventory(prev => prev.map(i => 
                            i.firebaseId === item.firebaseId ? { ...i, stockDomicilio: newStock } : i
                        ));
                        await updateLocalAndRemote('inventory_stable', item.firebaseId, { stockDomicilio: newStock });
                    }
                }
            };

            const handleMarkHalfEmpty = async (item) => {
                const currentHalves = sessionRestocks[item.name]?.halves || 0;
                const newHalves = currentHalves + 1;
                
                if (newHalves >= 2) {
                    if (item.stockDomicilio > 0) {
                        const newStock = item.stockDomicilio - 1;
                        setInventory(prev => prev.map(i => 
                            i.firebaseId === item.firebaseId ? { ...i, stockDomicilio: newStock } : i
                        ));
                        await updateLocalAndRemote('inventory_stable', item.firebaseId, { stockDomicilio: newStock });
                    }
                    
                    setSessionUsage(prev => ({ 
                        ...prev, 
                        [item.name]: { uses: (prev[item.name]?.uses || 0) + 1, unit: item.unit } 
                    }));
                    
                    setSessionRestocks(prev => {
                        const updated = {...prev};
                        delete updated[item.name];
                        return updated;
                    });
                    
                    showNotification('‚úì Unidad completa registrada (2 mitades)', 'success');
                } else {
                    setSessionRestocks(prev => ({ 
                        ...prev, 
                        [item.name]: { unit: item.unit, halves: newHalves } 
                    }));
                    showNotification('‚ö†Ô∏è Primera mitad registrada (falta 1 m√°s)', 'warning');
                }
            };

            const handleAdminUpdate = async (item, field, newValue) => {
                let val = newValue === '' ? '' : newValue;
                
                if (val !== '') {
                    val = parseInt(val);
                    if (isNaN(val) || val < 0) return;
                }
                
                if (field === 'stockDomicilio' && val !== '') {
                    const diff = val - (item.stockDomicilio || 0);
                    if (diff > 0) {
                        setSessionUsage(prev => ({ 
                            ...prev, 
                            [item.name]: { uses: (prev[item.name]?.uses || 0) + diff, unit: item.unit } 
                        }));
                    }
                }
                
                setInventory(prev => prev.map(i => 
                    i.firebaseId === item.firebaseId ? { ...i, [field]: val === '' ? 0 : val } : i
                ));
                
                if (val !== '') {
                    await updateLocalAndRemote('inventory_stable', item.firebaseId, { [field]: val });
                }
            };

            // FIX #1: Funci√≥n para abrir modal de edici√≥n de insumo
            const openEditSupply = (item) => {
                setEditSupplyData({
                    firebaseId: item.firebaseId,
                    name: item.name,
                    unit: item.unit,
                    cat: item.cat || 'Farmacia',
                    min: item.min,
                    stockDomicilio: item.stockDomicilio
                });
                setShowEditSupply(true);
            };

            // FIX #1: Funci√≥n para guardar edici√≥n de insumo - CORREGIDO
            const handleSaveEditSupply = async () => {
                if (!editSupplyData.name.trim()) {
                    showNotification('‚ö†Ô∏è El nombre es obligatorio', 'warning');
                    return;
                }
                
                const updatedItem = {
                    name: editSupplyData.name.toUpperCase(),
                    unit: editSupplyData.unit,
                    cat: editSupplyData.cat,
                    min: editSupplyData.min,
                    stockDomicilio: editSupplyData.stockDomicilio
                };
                
                // Cerrar modal PRIMERO
                setShowEditSupply(false);
                
                // Actualizar UI local inmediatamente
                setInventory(prev => prev.map(i => 
                    i.firebaseId === editSupplyData.firebaseId ? { ...i, ...updatedItem } : i
                ).sort((a, b) => a.name.localeCompare(b.name)));
                
                showNotification('‚úì MATERIAL ACTUALIZADO', 'success');
                
                // Guardar en Firebase en background
                try {
                    await updateLocalAndRemote('inventory_stable', editSupplyData.firebaseId, updatedItem);
                    console.log('‚úì Material guardado en Firebase');
                } catch(e) {
                    console.error('Error guardando en Firebase:', e);
                }
            };

            const sendReportToAdmin = async () => {
                try {
                    const isAdmin = activeNurse?.id === ADMIN_ID;
                    const dateStr = new Date().toLocaleDateString();
                    const timeStr = new Date().toLocaleTimeString();
                    
                    const hasUsage = Object.keys(sessionUsage).length > 0;
                    const hasRestocks = Object.keys(sessionRestocks).length > 0;

                    if (!hasUsage && !hasRestocks) return true;

                    let subject = '';
                    let body = '';
                    let from = '';
                    let to = '';
                    
                    if (isAdmin) {
                        const list = Object.entries(sessionUsage)
                            .map(([n, d]) => `- ${n.toUpperCase()}: +${d.uses} ${d.unit}`)
                            .join('\n');
                        subject = `REPOSICI√ìN: Insumos - ${dateStr}`;
                        body = `SE HAN RECARGADO LOS SIGUIENTES MATERIALES:\n\n${list}\n\nFecha: ${dateStr} ${timeStr}`;
                        from = activeNurse?.name || 'Administrador';
                        to = 'Enfermeros';
                    } else {
                        // Guardar log de turno (no bloqueante)
                        const shiftData = { 
                            nurse: activeNurse?.name || 'Enfermero', 
                            timestamp: new Date().toISOString(), 
                            itemsUsed: sessionUsage,
                            restocks: sessionRestocks
                        };
                        
                        // Ejecutar en background sin bloquear
                        addDoc(collection(db, 'artifacts', APP_ID_DB, 'public', 'data', 'logs_turnos'), shiftData)
                            .then(() => console.log('‚úì Log de turno guardado'))
                            .catch(e => console.log('Log turno error:', e));
                        
                        const usageList = Object.entries(sessionUsage)
                            .map(([n, d]) => `- ${n.toUpperCase()}: ${d.uses} ${UNIDADES_INCONTABLES.includes(d.unit) ? 'USOS' : d.unit}`)
                            .join('\n');
                        
                        const restockList = Object.entries(sessionRestocks)
                            .map(([n, data]) => `- ${n.toUpperCase()}: ${data?.halves || 1}/2 MITADES`)
                            .join('\n');
                        
                        subject = `GUARDIA: ${activeNurse?.name || 'Enfermero'} - ${dateStr}`;
                        body = `REPORTE DE GUARDIA\n\nEnfermero: ${activeNurse?.name || 'Enfermero'}\nFecha: ${dateStr}\nHora: ${timeStr}\n`;
                        if (hasUsage) body += `\n------- CONSUMOS -------\n${usageList}\n`;
                        if (hasRestocks) body += `\n‚ö†Ô∏è ALERTAS ‚ö†Ô∏è\n${restockList}\n`;
                        from = activeNurse?.name || 'Enfermero';
                        to = 'Administrador';
                    }
                    
                    // Crear el mensaje
                    const messageData = {
                        from: from,
                        to: to,
                        subject: subject,
                        body: body,
                        timestamp: new Date().toISOString(),
                        read: false
                    };
                    
                    console.log('üìß Enviando mensaje:', messageData);
                    
                    await addDoc(collection(db, 'artifacts', APP_ID_DB, 'public', 'data', 'messages'), messageData);
                    console.log('‚úì Mensaje enviado correctamente');
                    return true;
                } catch(error) {
                    console.error("‚ùå Error enviando reporte:", error);
                    return false;
                }
            };

            const confirmAndExit = async () => {
                setShowShiftEnd(false);
                showNotification('‚è≥ Enviando reporte...', 'info', 2000);
                
                const success = await sendReportToAdmin();
                
                if (success) {
                    showNotification('‚úì Reporte enviado correctamente', 'success');
                    setTimeout(() => resetSession(), 2000);
                } else {
                    showNotification('‚ùå Error al enviar. Saliendo...', 'error');
                    setTimeout(() => resetSession(), 2000);
                }
            };

            const resetSession = () => { 
                setActiveNurse(null); 
                setView('login'); 
                setShowShiftEnd(false); 
                setSessionUsage({}); 
                setSessionRestocks({});
                setLoginForm({ id: '', pin: '' });
            };

            // FIX #2: Mejorar handleAddSupply con notificaci√≥n clara
            const handleAddSupply = async () => {
                if (!newSupply.name || !newSupply.name.trim()) {
                    showNotification('‚ö†Ô∏è El nombre es obligatorio', 'warning');
                    return;
                }
                
                const id = Date.now().toString();
                const newItem = { 
                    ...newSupply, 
                    id, 
                    firebaseId: id, 
                    stockDomicilio: 50,
                    name: newSupply.name.toUpperCase()
                };
                
                setInventory(prev => [...prev, newItem].sort((a, b) => a.name.localeCompare(b.name)));
                await updateLocalAndRemote('inventory_stable', id, newItem);
                
                // Cerrar modal primero
                setShowAddSupply(false);
                setNewSupply({ name: '', unit: 'UNID', cat: 'Farmacia', min: 1 });
                
                // Mostrar notificaci√≥n clara
                showNotification('‚úì NUEVO MATERIAL CREADO', 'success', 3000);
            };

            // FIX #4: Mejorar saveNurse para que guarde PIN correctamente
            const saveNurse = async (e) => {
                e.preventDefault();
                if (!nurseEditor.name.trim() || !nurseEditor.pin.trim()) {
                    showNotification('‚ö†Ô∏è Todos los campos son obligatorios', 'warning');
                    return;
                }
                
                const id = nurseEditor.id || nurseEditor.name.toLowerCase().replace(/\s/g, '_');
                const newNurseData = { 
                    id, 
                    name: nurseEditor.name.toUpperCase(), 
                    email: nurseEditor.email.toLowerCase(), 
                    pin: nurseEditor.pin, 
                    profileComplete: true,
                    needsReset: false
                };
                
                // Guardar en Firebase PRIMERO
                const success = await updateLocalAndRemote('nurses', id, newNurseData);
                
                if (success) {
                    setNurses(prev => {
                        const exists = prev.find(n => n.id === id);
                        if (exists) return prev.map(n => n.id === id ? newNurseData : n);
                        return [...prev, newNurseData];
                    });
                    
                    setShowNurseModal(false);
                    showNotification('‚úì PERSONAL GUARDADO CORRECTAMENTE', 'success');
                } else {
                    showNotification('‚ùå Error guardando - Intente de nuevo', 'error');
                }
            };

            const deleteNurse = async (id) => {
                if(!window.confirm("¬øEliminar acceso?")) return;
                setNurses(prev => prev.filter(n => n.id !== id)); 
                try { 
                    await deleteDoc(doc(db, 'artifacts', APP_ID_DB, 'public', 'data', 'nurses', id));
                    showNotification('‚úì Personal eliminado', 'success');
                } catch(e){ 
                    setOfflineMode(true); 
                }
            };

            // Forzar que un enfermero vuelva a registrarse
            const forceReRegister = async (nurse) => {
                if(!window.confirm(`¬øForzar re-registro de ${nurse.name}? Deber√° ingresar nombre y PIN nuevo.`)) return;
                
                const updated = { 
                    ...nurse, 
                    profileComplete: false, 
                    pin: '0000',
                    needsReset: false 
                };
                
                setNurses(prev => prev.map(n => n.id === nurse.id ? updated : n));
                
                try {
                    await updateLocalAndRemote('nurses', nurse.id, { 
                        profileComplete: false, 
                        pin: '0000',
                        needsReset: false 
                    });
                    showNotification(`‚úì ${nurse.name} debe re-registrarse con PIN 0000`, 'success');
                } catch(e) {
                    showNotification('‚ùå Error', 'error');
                }
            };

            const deleteInventoryItem = async (firebaseId) => {
                if(!window.confirm("¬øConfirma eliminar este material?")) return;
                
                try {
                    setInventory(prev => prev.filter(i => i.firebaseId !== firebaseId));
                    await deleteDoc(doc(db, 'artifacts', APP_ID_DB, 'public', 'data', 'inventory_stable', firebaseId));
                    showNotification('‚úì Insumo borrado', 'success');
                } catch(e){ 
                    setOfflineMode(true);
                }
            };

            const markAsRead = async (messageId) => {
                try {
                    await updateDoc(doc(db, 'artifacts', APP_ID_DB, 'public', 'data', 'messages', messageId), { read: true });
                } catch(e) {}
            };

            // NUEVO: Funci√≥n para refrescar mensajes desde el servidor
            const refreshMessages = async () => {
                console.log('üîÑ Forzando actualizaci√≥n de mensajes desde servidor...');
                showNotification('üîÑ Actualizando mensajes...', 'info', 2000);
                
                try {
                    const messagesRef = collection(db, 'artifacts', APP_ID_DB, 'public', 'data', 'messages');
                    const snapshot = await getDocsFromServer(messagesRef);
                    
                    if (!snapshot.empty) {
                        const loadedMessages = snapshot.docs.map(d => ({ ...d.data(), id: d.id })).sort((a, b) => 
                            new Date(b.timestamp) - new Date(a.timestamp)
                        );
                        setMessages(loadedMessages);
                        console.log('‚úÖ Mensajes actualizados:', loadedMessages.length);
                        showNotification(`‚úÖ ${loadedMessages.length} mensajes cargados`, 'success');
                    } else {
                        setMessages([]);
                        showNotification('üì≠ No hay mensajes', 'info');
                    }
                    setOfflineMode(false);
                } catch(e) {
                    console.error('‚ùå Error actualizando mensajes:', e);
                    showNotification('‚ùå Error de conexi√≥n', 'error');
                    setOfflineMode(true);
                }
            };

            // NUEVO: Funci√≥n para refrescar datos de enfermeros desde el servidor  
            const refreshNurses = async () => {
                console.log('üîÑ Forzando actualizaci√≥n de enfermeros desde servidor...');
                
                try {
                    const nursesRef = collection(db, 'artifacts', APP_ID_DB, 'public', 'data', 'nurses');
                    const snapshot = await getDocsFromServer(nursesRef);
                    
                    if (!snapshot.empty) {
                        const loadedNurses = snapshot.docs.map(d => ({ ...d.data(), firebaseId: d.id }));
                        setNurses(loadedNurses);
                        console.log('‚úÖ Enfermeros actualizados:', loadedNurses.length);
                    }
                } catch(e) {
                    console.error('‚ùå Error actualizando enfermeros:', e);
                }
            };

            // FIX #5: Funci√≥n para borrar mensaje - CORREGIDO
            const deleteMessage = async (messageId) => {
                // Primero actualizar UI localmente
                setMessages(prev => prev.filter(m => m.id !== messageId));
                setSelectedMessage(null);
                showNotification('‚úì Mensaje eliminado', 'success');
                
                // Luego intentar eliminar de Firebase en background
                try {
                    const messageRef = doc(db, 'artifacts', APP_ID_DB, 'public', 'data', 'messages', messageId);
                    await deleteDoc(messageRef);
                    console.log('‚úì Mensaje eliminado de Firebase:', messageId);
                } catch(e) {
                    console.error('Error eliminando de Firebase:', e);
                    // El mensaje ya se elimin√≥ de la UI, no molestamos al usuario
                }
            };

            const openNurseModal = (nurse = null) => {
                if (nurse) {
                    setNurseEditor({ id: nurse.id, name: nurse.name, email: nurse.email || '', pin: nurse.pin, mode: 'edit' });
                } else {
                    setNurseEditor({ id: '', name: '', email: '', pin: '', mode: 'add' });
                }
                setShowNurseModal(true);
            };

            if (authLoading) return (
                <div className="h-screen flex items-center justify-center bg-blue-700 text-white font-black text-xs uppercase">
                    <div className="text-center">
                        <div className="w-12 h-12 border-4 border-white/20 border-t-white rounded-full animate-spin mx-auto mb-4"></div>
                        RECALDE_NURSING...
                    </div>
                </div>
            );

            const filteredInventory = inventory.filter(i => i.name.toLowerCase().includes(search.toLowerCase()));
            const nursesNeedingReset = nurses.filter(n => n.needsReset && n.id !== ADMIN_ID);
            
            const filteredMessages = activeNurse ? messages.filter(msg => {
                if (activeNurse.id === ADMIN_ID) return msg.to === 'Administrador';
                return msg.to === 'Enfermeros';
            }) : [];
            
            const unreadMessages = filteredMessages.filter(m => !m.read).length;

            return (
                <div className="min-h-screen bg-slate-50 pb-24 font-sans relative">
                    <GlobalNotification message={notification} type={notificationType} />
                    
                    {offlineMode && (
                        <div className="fixed top-16 left-1/2 -translate-x-1/2 z-[190] px-4 py-3 bg-red-500 text-white rounded-2xl shadow-lg flex items-center gap-2 animate-pulse">
                            <WifiOff className="w-4 h-4" />
                            <span className="text-[10px] font-black uppercase">‚ö†Ô∏è SIN CONEXI√ìN A FIREBASE - Los datos NO se sincronizan</span>
                        </div>
                    )}
                    
                    {!offlineMode && user && (
                        <div className="fixed top-16 left-1/2 -translate-x-1/2 z-[190] px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full shadow-sm flex items-center gap-1 opacity-70">
                            <span className="text-[8px] font-black uppercase">‚úì Conectado</span>
                        </div>
                    )}

                    {view === 'login' && (
                        <div className="min-h-screen bg-gradient-to-b from-slate-100 to-slate-200 flex items-center justify-center p-4">
                            <div className="w-full max-w-sm">
                                <div className="text-center mb-10">
                                    <div className="flex justify-center mb-6">
                                        <div className="logo-float">
                                            <svg width="90" height="90" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <defs>
                                                    <linearGradient id="shieldGradient" x1="50" y1="10" x2="50" y2="90" gradientUnits="userSpaceOnUse">
                                                        <stop stopColor="#3b82f6"/>
                                                        <stop offset="1" stopColor="#1d4ed8"/>
                                                    </linearGradient>
                                                </defs>
                                                <path d="M50 10C30 10 15 15 15 15V55C15 75 50 90 50 90C50 90 85 75 85 55V15C85 15 70 10 50 10Z" fill="url(#shieldGradient)" stroke="#1e40af" strokeWidth="2"/>
                                                <rect x="43" y="28" width="14" height="40" rx="3" fill="white"/>
                                                <rect x="33" y="40" width="34" height="14" rx="3" fill="white"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <h1 className="text-3xl font-black text-slate-800 tracking-tight">RECALDE</h1>
                                    <h2 className="text-xl font-bold text-blue-600 tracking-wide">NURSING</h2>
                                    <p className="text-xs font-semibold text-slate-400 uppercase tracking-widest mt-3">Portal de Enfermer√≠a Domiciliaria</p>
                                </div>
                                
                                <form onSubmit={handleLogin} className="space-y-5">
                                    <div className="relative">
                                        <select className="w-full p-5 pr-12 rounded-2xl border-2 border-slate-200 font-semibold text-slate-600 text-sm bg-white outline-none focus:border-blue-500 appearance-none cursor-pointer" value={loginForm.id} onChange={e => setLoginForm({...loginForm, id: e.target.value})}>
                                            <option value="">¬øQUI√âN SOS?</option>
                                            {nurses.map(n => <option key={n.id} value={n.id}>{String(n.name)}</option>)}
                                        </select>
                                        <svg className="absolute right-5 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </div>
                                    <input type="password" placeholder="P I N" className="w-full p-5 rounded-2xl border-2 border-slate-200 text-center font-bold text-2xl tracking-[0.4em] outline-none focus:border-blue-500 bg-white" value={loginForm.pin} onChange={e => setLoginForm({...loginForm, pin: e.target.value})} />
                                    {loginError && <p className="text-red-500 text-xs font-bold text-center animate-pulse">{loginError}</p>}
                                    <button className="w-full p-5 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-full text-sm uppercase tracking-wider shadow-lg shadow-blue-500/30 active:scale-[0.98] transition-all">Ingresar al Portal</button>
                                    <div className="text-center pt-2">
                                        <button type="button" onClick={() => setShowForgotPin(true)} className="text-xs font-semibold text-blue-500 hover:text-blue-700">¬øOlvidaste tu PIN?</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {showForgotPin && (
                        <div className="fixed inset-0 bg-slate-900/95 modal-blur z-[150] flex items-center justify-center p-6 text-center">
                            <div className="bg-white w-full max-w-sm rounded-[3rem] p-10 shadow-2xl">
                                <h3 className="text-[11px] font-black uppercase text-slate-800 mb-2">¬øOlvid√≥ su PIN?</h3>
                                <p className="text-[10px] font-black uppercase text-slate-500 mb-6 leading-relaxed">
                                    {loginForm.id 
                                        ? `Solicitar√° ayuda para resetear el PIN de ${nurses.find(n => n.id === loginForm.id)?.name}.`
                                        : 'Primero seleccione su nombre en la pantalla de login.'}
                                </p>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowForgotPin(false)} className="flex-1 p-4 bg-slate-100 text-slate-400 font-black rounded-2xl uppercase text-[9px]">Atr√°s</button>
                                    <button onClick={handleForgotPin} className="flex-1 p-4 bg-blue-500 text-white font-black rounded-2xl uppercase text-[9px] shadow-lg">
                                        {loginForm.id ? 'Enviar Solicitud' : 'Volver'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {view === 'reset_pin' && (
                        <div className="min-h-screen bg-blue-600 flex items-center justify-center p-6">
                            <div className="bg-white w-full max-w-md rounded-[3rem] p-10 shadow-2xl text-center">
                                <h2 className="font-black uppercase text-sm mb-4">DEFINE TU NUEVO PIN</h2>
                                <p className="text-[9px] font-bold text-slate-400 uppercase mb-6">Crea tu nuevo PIN personal de acceso.</p>
                                <form onSubmit={handleDefineNewPin} className="space-y-4">
                                    <input required type="password" className="w-full p-5 rounded-2xl bg-slate-50 text-center font-black text-2xl tracking-[0.5em] outline-none" placeholder="NUEVO PIN" maxLength={6} value={setupData.newPin} onChange={e => setSetupData({...setupData, newPin: e.target.value})} />
                                    <input required type="password" className="w-full p-5 rounded-2xl bg-slate-50 text-center font-black text-2xl tracking-[0.5em] outline-none" placeholder="CONFIRMAR PIN" maxLength={6} value={setupData.confirmPin} onChange={e => setSetupData({...setupData, confirmPin: e.target.value})} />
                                    <button className="w-full p-6 bg-emerald-500 text-white font-black rounded-3xl uppercase text-[10px] shadow-xl active:scale-95 transition-all">Habilitar mi PIN</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {view === 'setup_profile' && (
                        <div className="min-h-screen bg-blue-600 flex items-center justify-center p-6">
                            <div className="bg-white w-full max-w-md rounded-[3rem] p-10 shadow-2xl text-center">
                                <h2 className="font-black uppercase text-sm mb-4">REGISTRO INICIAL</h2>
                                <p className="text-[9px] font-bold text-slate-400 uppercase mb-6">Complete su nombre y elija un PIN personal.</p>
                                <form onSubmit={handleCompleteProfile} className="space-y-4">
                                    <input required type="text" className="w-full p-5 rounded-2xl bg-slate-50 font-bold uppercase text-[10px] outline-none" placeholder="NOMBRE Y APELLIDO COMPLETO" value={setupData.fullName} onChange={e => setSetupData({...setupData, fullName: e.target.value})} />
                                    <input required type="password" className="w-full p-5 rounded-2xl bg-slate-50 text-center font-black text-2xl tracking-[0.5em] outline-none" placeholder="NUEVO PIN" maxLength={6} value={setupData.newPin} onChange={e => setSetupData({...setupData, newPin: e.target.value})} />
                                    <input required type="password" className="w-full p-5 rounded-2xl bg-slate-50 text-center font-black text-2xl tracking-[0.5em] outline-none" placeholder="CONFIRMAR PIN" maxLength={6} value={setupData.confirmPin} onChange={e => setSetupData({...setupData, confirmPin: e.target.value})} />
                                    <button className="w-full p-6 bg-emerald-500 text-white font-black rounded-3xl uppercase text-[10px] shadow-xl active:scale-95 transition-all">Guardar y Comenzar</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {view === 'manage_nurses' && (
                        <div className="min-h-screen bg-slate-100 p-4">
                            <div className="max-w-md mx-auto bg-white rounded-[2.5rem] p-8 shadow-xl border flex flex-col h-[85vh]">
                                <div className="flex justify-between items-center mb-6 shrink-0">
                                    <h2 className="font-black uppercase text-sm text-slate-800 tracking-tighter">GESTI√ìN DE PERSONAL</h2>
                                    <div className="flex items-center gap-2">
                                        <button onClick={refreshNurses} className="bg-blue-500 text-white p-2 rounded-xl active:bg-blue-600" title="Actualizar lista">
                                            <RefreshCw className="w-4 h-4" />
                                        </button>
                                        <button onClick={() => activeNurse ? setView('portal') : setView('login')} className="bg-slate-100 p-2 rounded-xl hover:bg-slate-200"><X className="w-4 h-4" /></button>
                                    </div>
                                </div>
                                
                                {nursesNeedingReset.length > 0 && (
                                    <div className="mb-4 shrink-0">
                                        <p className="text-[9px] font-black text-red-600 uppercase mb-2 flex items-center gap-1">
                                            <AlertTriangle className="w-3 h-3" /> Solicitudes de reseteo pendientes
                                        </p>
                                        {nursesNeedingReset.map(n => (
                                            <div key={n.id} className="bg-red-50 border-2 border-red-200 rounded-2xl p-4 mb-2">
                                                <div className="flex justify-between items-center">
                                                    <div>
                                                        <p className="font-black text-[10px] text-red-700 uppercase">{n.name}</p>
                                                        <p className="text-[8px] text-red-500">Solicita reseteo de PIN</p>
                                                    </div>
                                                    <button onClick={() => handleResetNurseToDefault(n)} className="bg-red-600 text-white px-4 py-2 rounded-xl text-[9px] font-black uppercase active:scale-95 transition-all">
                                                        Resetear a 0000
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                <div className="space-y-4 mb-6 overflow-y-auto flex-1 pr-2 border-t border-b border-slate-100 py-4">
                                    {nurses.map(n => (
                                        <div key={n.id} className="p-5 bg-white rounded-3xl border border-slate-100 shadow-sm hover:border-blue-200 transition-all">
                                            <div className="flex justify-between items-start">
                                                <div className="max-w-[60%]">
                                                    <p className="font-black uppercase text-[11px] text-slate-800">{String(n.name)}</p>
                                                    <p className="text-[8px] text-slate-400 lowercase mt-1 truncate">{String(n.email || 'Sin email')}</p>
                                                    <div className="flex items-center gap-2 mt-2">
                                                        <span className="text-[9px] text-blue-600 bg-blue-50 px-2 rounded font-black">PIN: {String(n.pin)}</span>
                                                        {!n.profileComplete && <span className="text-[7px] font-black bg-amber-100 text-amber-600 px-1 rounded uppercase">Pendiente</span>}
                                                    </div>
                                                </div>
                                                <div className="flex gap-1.5 flex-wrap justify-end">
                                                    <button onClick={() => openNurseModal(n)} className="p-2 text-blue-600 bg-blue-50 rounded-xl font-bold text-[9px] uppercase hover:bg-blue-600 hover:text-white transition-all">Edit</button>
                                                    {n.id !== ADMIN_ID && n.profileComplete && (
                                                        <button onClick={() => forceReRegister(n)} className="p-2 text-amber-600 bg-amber-50 rounded-xl font-bold text-[8px] uppercase hover:bg-amber-500 hover:text-white transition-all">Re-reg</button>
                                                    )}
                                                    {n.id !== ADMIN_ID && (
                                                        <button onClick={() => deleteNurse(n.id)} className="p-2 text-red-500 bg-red-50 rounded-xl hover:bg-red-500 hover:text-white transition-all font-black">‚úï</button>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => openNurseModal()} className="w-full p-6 bg-blue-600 text-white font-black rounded-3xl uppercase text-[10px] shadow-xl active:scale-95 transition-all flex items-center justify-center gap-2 shrink-0">
                                    <Plus className="w-4 h-4" /> A√±adir Personal
                                </button>
                            </div>
                        </div>
                    )}

                    {view === 'portal' && (
                        <>
                            <header className={`border-b px-4 py-4 sticky top-0 z-40 flex justify-between items-center shadow-sm ${activeNurse?.id === ADMIN_ID ? 'bg-blue-600 text-white' : 'bg-white'}`}>
                                <div className="flex flex-col">
                                    <span className={`text-[10px] font-black uppercase tracking-tighter ${activeNurse?.id === ADMIN_ID ? 'text-blue-100' : 'text-slate-900'}`}>RECALDE_NURSING</span>
                                    <span className={`text-[8px] font-bold uppercase ${activeNurse?.id === ADMIN_ID ? 'text-blue-100' : 'text-slate-400'}`}>
                                        {activeNurse?.id === ADMIN_ID ? 'MODO ADMINISTRADOR' : String(activeNurse?.name || '')}
                                    </span>
                                </div>
                                <div className="flex gap-2 flex-wrap justify-end">
                                    {activeNurse?.id === ADMIN_ID && (
                                        <>
                                            <button onClick={() => { setShowMessages(true); refreshMessages(); }} className="bg-blue-800 text-[8px] font-black px-3 py-2 rounded-2xl uppercase border border-blue-400 relative">
                                                Mensajes
                                                {unreadMessages > 0 && <span className="absolute -top-2 -right-2 bg-red-500 text-white text-[8px] font-black w-5 h-5 rounded-full flex items-center justify-center">{unreadMessages}</span>}
                                            </button>
                                            <button onClick={() => setView('manage_nurses')} className="bg-blue-800 text-[8px] font-black px-3 py-2 rounded-2xl uppercase border border-blue-400">Personal</button>
                                            <button onClick={() => setShowAddSupply(true)} className="bg-blue-500 text-[8px] font-black px-3 py-2 rounded-2xl uppercase border border-blue-400">Material</button>
                                        </>
                                    )}
                                    {activeNurse?.id !== ADMIN_ID && (
                                        <button onClick={() => { setShowMessages(true); refreshMessages(); }} className="bg-slate-700 text-white text-[8px] font-black px-3 py-2 rounded-2xl uppercase relative">
                                            Mensajes
                                            {unreadMessages > 0 && <span className="absolute -top-2 -right-2 bg-red-500 text-white text-[8px] font-black w-5 h-5 rounded-full flex items-center justify-center">{unreadMessages}</span>}
                                        </button>
                                    )}
                                    <button onClick={() => resetSession()} className="bg-red-500 text-white text-[8px] font-black px-3 py-2 rounded-2xl uppercase shadow-lg active:scale-95 flex items-center gap-1">
                                        <LogOut className="w-3 h-3" /> Salir
                                    </button>
                                    <button onClick={() => setShowShiftEnd(true)} className={`text-[8px] font-black px-4 py-2 rounded-2xl uppercase shadow-lg active:scale-95 flex items-center gap-1 ${activeNurse?.id === ADMIN_ID ? 'bg-white text-blue-600' : 'bg-slate-900 text-white'}`}>
                                        <Send className="w-3 h-3" /> Enviar
                                    </button>
                                </div>
                            </header>

                            <main className="w-full max-w-7xl mx-auto p-4 md:p-8">
                                <div className="relative mb-6">
                                    <input type="text" placeholder="BUSCAR MATERIAL..." className="w-full p-5 pl-12 rounded-3xl shadow-sm border-none font-bold uppercase text-[10px] outline-none focus:ring-4 focus:ring-blue-100 bg-white" onChange={e => setSearch(e.target.value)}/>
                                    <Search className="absolute left-5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-300" />
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {filteredInventory.map(item => {
                                        const isLow = item.stockDomicilio <= item.min;
                                        const isAdmin = activeNurse?.id === ADMIN_ID;
                                        const isIncontable = UNIDADES_INCONTABLES.includes(item.unit);
                                        return (
                                            <div key={item.firebaseId} className={`bg-white rounded-[2.5rem] p-6 shadow-sm border ${isLow ? 'border-red-200 bg-red-50/10' : 'border-slate-100'} flex flex-col gap-4 hover:border-blue-200 transition-all h-full justify-between`}>
                                                <div className="flex justify-between items-start">
                                                    <div className="flex-1 pr-4">
                                                        <p className="font-black text-slate-800 uppercase text-[10px] leading-tight mb-2">{String(item.name)}</p>
                                                        <span className="text-[8px] font-black text-slate-400 bg-slate-50 px-2 py-1 rounded uppercase">{String(item.unit)}</span>
                                                        {/* FIX #1: Botones de editar y borrar para admin */}
                                                        {isAdmin && (
                                                            <div className="flex gap-1 mt-2">
                                                                <button onClick={() => openEditSupply(item)} className="text-blue-500 hover:text-blue-700 text-[8px] font-black uppercase flex items-center gap-1">
                                                                    <Edit3 className="w-3 h-3" /> Editar
                                                                </button>
                                                                <button onClick={() => deleteInventoryItem(item.firebaseId)} className="text-red-400 hover:text-red-600 text-[8px] font-black uppercase flex items-center gap-1 ml-2">
                                                                    <Trash2 className="w-3 h-3" /> Borrar
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="text-right min-w-[120px]">
                                                        {isAdmin ? (
                                                            <div className="flex flex-col gap-2 min-w-[120px]">
                                                                <div className="flex flex-col text-blue-600">
                                                                    <span className="text-[7px] font-black uppercase mb-1">Stock:</span>
                                                                    <div className="flex items-center gap-1">
                                                                        <button onClick={() => handleAdminUpdate(item, 'stockDomicilio', (item.stockDomicilio || 0) - 1)} className="w-8 h-8 bg-slate-100 rounded-xl font-black shadow-sm flex items-center justify-center active:bg-slate-200">-</button>
                                                                        <input type="number" className="w-14 p-2 bg-blue-50 border-2 border-blue-100 rounded-xl text-center font-black text-blue-700 text-xs outline-none" value={item.stockDomicilio} onChange={(e) => handleAdminUpdate(item, 'stockDomicilio', e.target.value)} onFocus={(e) => e.target.select()} />
                                                                        <button onClick={() => handleAdminUpdate(item, 'stockDomicilio', (item.stockDomicilio || 0) + 1)} className="w-8 h-8 bg-slate-100 rounded-xl font-black shadow-sm flex items-center justify-center active:bg-slate-200">+</button>
                                                                    </div>
                                                                </div>
                                                                <div className="flex flex-col text-amber-600">
                                                                    <span className="text-[7px] font-black uppercase mb-1">M√≠nimo:</span>
                                                                    <input type="number" className="w-full p-2 bg-amber-50 border-2 border-amber-100 rounded-xl text-center font-black text-amber-700 text-xs outline-none" value={item.min} onChange={(e) => handleAdminUpdate(item, 'min', e.target.value)} onFocus={(e) => e.target.select()} />
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            <div className="flex flex-col items-end">
                                                                <span className={`text-3xl font-black leading-none ${isLow ? 'text-red-500' : 'text-blue-600'}`}>{String(item.stockDomicilio)}</span>
                                                                <span className="text-[7px] font-black text-slate-300 uppercase mt-1 italic">Stock</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                {!isAdmin && (
                                                    <div className="bg-slate-50 p-3 rounded-[2rem] border border-slate-100 shadow-inner">
                                                        <p className="text-[7px] font-black text-slate-400 uppercase mb-2">Registro</p>
                                                        <div className="flex items-center gap-2">
                                                            <button onClick={() => handleRegisterUsage(item)} className="flex-1 h-12 bg-white border border-slate-200 rounded-2xl font-black text-[9px] uppercase shadow-sm active:bg-blue-600 active:text-white transition-all">
                                                                {isIncontable ? 'Usar' : 'Registrar'}
                                                            </button>
                                                            <div className="bg-white px-4 h-12 flex items-center rounded-2xl border border-slate-200 shadow-sm font-black">
                                                                <span className="font-black text-blue-700 text-sm">{sessionUsage[item.name]?.uses || 0}</span>
                                                            </div>
                                                            {isIncontable && (
                                                                <button onClick={() => handleMarkHalfEmpty(item)} className={`px-3 h-12 rounded-2xl border font-black text-[8px] uppercase transition-all ${sessionRestocks[item.name] ? 'bg-amber-500 text-white border-amber-600' : 'bg-amber-50 text-amber-700 border-amber-200 active:bg-amber-600 active:text-white'}`}>
                                                                    {sessionRestocks[item.name] ? `${sessionRestocks[item.name].halves || 1}/2` : 'Mitad'}
                                                                </button>
                                                            )}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </main>
                        </>
                    )}

                    {/* FIX #5: Modal de mensajes con bot√≥n borrar */}
                    {showMessages && (
                        <div className="fixed inset-0 bg-slate-900/95 modal-blur z-[150] flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-2xl rounded-[3rem] p-6 shadow-2xl max-h-[85vh] flex flex-col">
                                <div className="flex justify-between items-center mb-4 shrink-0">
                                    <h2 className="font-black uppercase text-sm text-slate-800">MENSAJES</h2>
                                    <div className="flex items-center gap-2">
                                        <button onClick={refreshMessages} className="bg-blue-500 text-white p-2 rounded-xl active:bg-blue-600" title="Actualizar mensajes">
                                            <RefreshCw className="w-4 h-4" />
                                        </button>
                                        <button onClick={() => { setShowMessages(false); setSelectedMessage(null); }} className="bg-slate-100 p-2 rounded-xl active:bg-slate-200"><X className="w-4 h-4" /></button>
                                    </div>
                                </div>
                                
                                {!selectedMessage ? (
                                    <div className="overflow-y-auto flex-1">
                                        {filteredMessages.length === 0 ? (
                                            <div className="text-center py-12">
                                                <p className="text-slate-400 text-[10px] font-black uppercase mb-4">No hay mensajes</p>
                                                <button onClick={refreshMessages} className="text-blue-500 text-[9px] font-black uppercase flex items-center gap-1 mx-auto bg-blue-50 px-4 py-2 rounded-xl">
                                                    <RefreshCw className="w-3 h-3" /> Actualizar
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="space-y-3">
                                                {filteredMessages.map(msg => (
                                                    <div key={msg.id} className={`p-4 rounded-2xl border ${msg.read ? 'bg-slate-50 border-slate-100' : 'bg-blue-50 border-blue-200'} cursor-pointer hover:shadow-md transition-all`}>
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex items-center gap-2 flex-1" onClick={() => { setSelectedMessage(msg); markAsRead(msg.id); }}>
                                                                {msg.read ? <MailOpen className="w-4 h-4 text-slate-400" /> : <Mail className="w-4 h-4 text-blue-600" />}
                                                                <span className="font-black text-[10px] uppercase text-slate-800">{msg.from}</span>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <span className="text-[8px] text-slate-400">{new Date(msg.timestamp).toLocaleDateString()}</span>
                                                                <button onClick={(e) => { e.stopPropagation(); deleteMessage(msg.id); }} className="text-red-400 hover:text-red-600 p-1">
                                                                    <Trash2 className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <p className="font-black text-[9px] text-slate-600" onClick={() => { setSelectedMessage(msg); markAsRead(msg.id); }}>{msg.subject}</p>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="flex-1 overflow-y-auto">
                                        <div className="flex justify-between items-center mb-4">
                                            <button onClick={() => setSelectedMessage(null)} className="text-blue-600 text-[9px] font-black uppercase flex items-center gap-1">‚Üê Volver</button>
                                            <button onClick={() => deleteMessage(selectedMessage.id)} className="text-red-500 text-[9px] font-black uppercase flex items-center gap-1 bg-red-50 px-3 py-1 rounded-xl">
                                                <Trash2 className="w-3 h-3" /> Eliminar
                                            </button>
                                        </div>
                                        <div className="bg-slate-50 rounded-2xl p-6">
                                            <div className="mb-4 pb-4 border-b border-slate-200">
                                                <p className="text-[8px] text-slate-400 mb-1">De: {selectedMessage.from}</p>
                                                <p className="text-[8px] text-slate-400 mb-3">{new Date(selectedMessage.timestamp).toLocaleString()}</p>
                                                <h3 className="font-black text-sm text-slate-800">{selectedMessage.subject}</h3>
                                            </div>
                                            <div className="whitespace-pre-wrap text-[10px] text-slate-600 leading-relaxed">{selectedMessage.body}</div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {showNurseModal && (
                        <div className="fixed inset-0 bg-slate-900/95 modal-blur z-[150] flex items-center justify-center p-6">
                            <div className="bg-white w-full max-w-sm rounded-[3rem] p-10 shadow-2xl">
                                <h2 className="font-black uppercase text-sm mb-10 text-center">PERFIL PERSONAL</h2>
                                <form onSubmit={saveNurse} className="space-y-4">
                                    <input required type="text" placeholder="NOMBRE COMPLETO" className="w-full p-5 rounded-[2rem] bg-slate-50 border-2 border-slate-50 font-bold text-[11px] uppercase outline-none focus:border-blue-500" value={nurseEditor.name} onChange={e => setNurseEditor({...nurseEditor, name: e.target.value.toUpperCase()})} />
                                    <input type="email" placeholder="EMAIL (OPCIONAL)" className="w-full p-5 rounded-[2rem] bg-slate-50 border-2 border-slate-50 font-bold text-[11px] outline-none" value={nurseEditor.email} onChange={e => setNurseEditor({...nurseEditor, email: e.target.value.toLowerCase()})} />
                                    <input required type="text" placeholder="PIN" className="w-full p-5 rounded-[2rem] bg-slate-50 border-2 border-slate-50 font-black text-center text-xl tracking-[0.6em] outline-none" maxLength={6} value={nurseEditor.pin} onChange={e => setNurseEditor({...nurseEditor, pin: e.target.value})} />
                                    <div className="flex gap-3 pt-6">
                                        <button type="button" onClick={() => setShowNurseModal(false)} className="flex-1 p-5 bg-slate-50 text-slate-400 font-black rounded-[2rem] uppercase text-[9px] active:scale-95">Atr√°s</button>
                                        <button type="submit" className="flex-1 p-5 bg-blue-600 text-white font-black rounded-[2rem] uppercase text-[9px] shadow-2xl active:scale-95">Guardar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {showAddSupply && (
                        <div className="fixed inset-0 bg-slate-900/95 modal-blur z-[100] flex items-center justify-center p-6">
                            <div className="bg-white w-full max-w-sm rounded-[3.5rem] p-10 shadow-2xl">
                                <h2 className="font-black uppercase text-sm mb-10 text-center text-slate-800">NUEVO MATERIAL</h2>
                                <div className="space-y-4">
                                    <input type="text" placeholder="NOMBRE DEL MATERIAL" className="w-full p-5 rounded-[2rem] bg-slate-50 border-2 border-slate-50 font-bold text-[10px] uppercase outline-none focus:border-blue-500" value={newSupply.name} onChange={e => setNewSupply({...newSupply, name: e.target.value.toUpperCase()})} />
                                    <div className="grid grid-cols-2 gap-3">
                                        <select className="w-full p-5 rounded-[2rem] bg-slate-50 border-2 border-slate-50 font-black text-[9px] uppercase outline-none" value={newSupply.unit} onChange={e => setNewSupply({...newSupply, unit: e.target.value})}>
                                            {UNIT_OPTIONS.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                                        </select>
                                        <input type="number" placeholder="M√çNIMO" className="w-full p-5 rounded-[2rem] bg-slate-50 border-2 border-slate-100 font-black text-[9px] outline-none" value={newSupply.min} onChange={e => setNewSupply({...newSupply, min: parseInt(e.target.value) || 0})} />
                                    </div>
                                    <div className="flex gap-3 pt-6">
                                        <button onClick={() => setShowAddSupply(false)} className="flex-1 p-5 bg-slate-100 text-slate-400 font-black rounded-[2rem] uppercase text-[9px] active:scale-95">Atr√°s</button>
                                        <button onClick={handleAddSupply} className="flex-1 p-5 bg-blue-600 text-white font-black rounded-[2rem] uppercase text-[9px] shadow-lg active:scale-95">Crear</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* FIX #1: Modal para editar insumo */}
                    {showEditSupply && (
                        <div className="fixed inset-0 bg-slate-900/95 modal-blur z-[100] flex items-center justify-center p-6">
                            <div className="bg-white w-full max-w-sm rounded-[3.5rem] p-10 shadow-2xl">
                                <h2 className="font-black uppercase text-sm mb-10 text-center text-slate-800">EDITAR MATERIAL</h2>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-[8px] font-black text-slate-400 uppercase mb-1 block">Nombre</label>
                                        <input type="text" className="w-full p-5 rounded-[2rem] bg-slate-50 border-2 border-slate-50 font-bold text-[10px] uppercase outline-none focus:border-blue-500" value={editSupplyData.name} onChange={e => setEditSupplyData({...editSupplyData, name: e.target.value.toUpperCase()})} />
                                    </div>
                                    <div>
                                        <label className="text-[8px] font-black text-slate-400 uppercase mb-1 block">Presentaci√≥n</label>
                                        <select className="w-full p-5 rounded-[2rem] bg-slate-50 border-2 border-slate-50 font-black text-[9px] uppercase outline-none" value={editSupplyData.unit} onChange={e => setEditSupplyData({...editSupplyData, unit: e.target.value})}>
                                            {UNIT_OPTIONS.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-[8px] font-black text-slate-400 uppercase mb-1 block">M√≠nimo</label>
                                            <input type="number" className="w-full p-5 rounded-[2rem] bg-amber-50 border-2 border-amber-100 font-black text-[9px] outline-none text-center" value={editSupplyData.min} onChange={e => setEditSupplyData({...editSupplyData, min: parseInt(e.target.value) || 0})} />
                                        </div>
                                        <div>
                                            <label className="text-[8px] font-black text-slate-400 uppercase mb-1 block">Stock</label>
                                            <input type="number" className="w-full p-5 rounded-[2rem] bg-blue-50 border-2 border-blue-100 font-black text-[9px] outline-none text-center" value={editSupplyData.stockDomicilio} onChange={e => setEditSupplyData({...editSupplyData, stockDomicilio: parseInt(e.target.value) || 0})} />
                                        </div>
                                    </div>
                                    <div className="flex gap-3 pt-6">
                                        <button onClick={() => setShowEditSupply(false)} className="flex-1 p-5 bg-slate-100 text-slate-400 font-black rounded-[2rem] uppercase text-[9px] active:scale-95">Cancelar</button>
                                        <button onClick={handleSaveEditSupply} className="flex-1 p-5 bg-emerald-500 text-white font-black rounded-[2rem] uppercase text-[9px] shadow-lg active:scale-95">Guardar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showShiftEnd && (
                        <div className="fixed inset-0 bg-slate-900/95 modal-blur z-[100] flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-[3.5rem] p-10 shadow-2xl">
                                <h2 className="font-black uppercase text-sm text-center mb-8">REVISAR REPORTE</h2>
                                <div className="bg-slate-50 p-6 rounded-[2.5rem] mb-10 max-h-64 overflow-y-auto border border-slate-200 shadow-inner no-scrollbar">
                                    {Object.keys(sessionUsage).length > 0 && (
                                        <div className="mb-4">
                                            <h3 className="text-[10px] font-black text-blue-600 uppercase mb-3 border-b border-blue-100 pb-2">
                                                {activeNurse?.id === ADMIN_ID ? 'Materiales Repuestos' : 'Materiales Utilizados'}
                                            </h3>
                                            <div className="space-y-3 px-2">
                                                {Object.entries(sessionUsage).map(([name, d]) => (
                                                    <div key={name} className="flex justify-between items-center py-2 border-b border-blue-50 last:border-0">
                                                        <p className="text-[9px] font-black uppercase text-slate-600 max-w-[70%]">{name}</p>
                                                        <span className="font-black text-blue-600 text-sm">{activeNurse?.id === ADMIN_ID ? `+${d.uses}` : `x${d.uses}`}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    {Object.keys(sessionRestocks).length > 0 && (
                                        <div>
                                            <h3 className="text-[10px] font-black text-amber-600 uppercase mb-3 border-b border-amber-100 pb-2 flex items-center gap-1">
                                                <AlertTriangle className="w-3 h-3" /> Alertas
                                            </h3>
                                            <div className="space-y-3 px-2">
                                                {Object.entries(sessionRestocks).map(([name, data]) => (
                                                    <div key={name} className="flex justify-between items-center py-2 border-b border-amber-50 last:border-0">
                                                        <p className="text-[9px] font-black uppercase text-slate-600 max-w-[70%]">{name}</p>
                                                        <span className="font-black text-amber-600 text-[7px] uppercase bg-amber-50 px-2 py-1 rounded">{data?.halves || 1}/2</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    {Object.keys(sessionUsage).length === 0 && Object.keys(sessionRestocks).length === 0 && (
                                        <p className="py-12 text-center text-[10px] font-black text-slate-300 uppercase italic">Sin actividad</p>
                                    )}
                                </div>
                                <div className="space-y-4 text-center">
                                    <button onClick={confirmAndExit} className="w-full p-6 text-white font-black rounded-[2rem] text-[11px] uppercase shadow-xl bg-blue-600 active:scale-95 flex items-center justify-center gap-2">
                                        <Send className="w-4 h-4" /> Enviar y Finalizar
                                    </button>
                                    <button onClick={() => setShowShiftEnd(false)} className="w-full py-2 text-slate-400 font-black text-[10px] uppercase hover:underline">Volver</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <footer className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-100 p-4 text-center shadow-sm">
                        <p className="text-[9px] font-black text-slate-900 uppercase tracking-widest">RECALDE_NURSING</p>
                        <p className="text-[7px] font-bold text-slate-400 uppercase mt-1">Portal de enfermer√≠a ‚Ä¢ 2026</p>
                    </footer>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => {
                        console.log('‚úì PWA Service Worker activo');
                        
                        // Buscar actualizaciones cada vez que se abre la app
                        reg.update();
                        
                        // Escuchar cuando hay una nueva versi√≥n lista
                        reg.addEventListener('updatefound', () => {
                            const newWorker = reg.installing;
                            console.log('üîÑ Descargando nueva versi√≥n...');
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'activated') {
                                    console.log('‚úÖ Nueva versi√≥n lista, recargando...');
                                    window.location.reload();
                                }
                            });
                        });
                    })
                    .catch(err => console.log('SW Error:', err));
            });
            
            // Escuchar mensajes del Service Worker
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'UPDATE_AVAILABLE') {
                    console.log('üì¶ Actualizaci√≥n disponible:', event.data.version);
                    window.location.reload();
                }
            });
            
            // Recargar cuando el SW toma control
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('üîÑ Nuevo Service Worker activo, recargando...');
                window.location.reload();
            });
        }
    </script>
</body>
</html>
